hosts -- Файл с узлами, заполняется записями вида "kafka-1 ansible_host=192.168.122.142.xip.io node_id=1".
kafka_cluster.yml -- Плейбук установки и изменения кластера.

Примеры использования:

ansible-playbook -i hosts kafka_cluster.yml -- Запустить установку на все узлы из группы kafka в перечисленные в файле hosts. Если на каких-то хостах kafka уже установленна, они будут пропущенны, а установка будет произведена на остальные.

ansible-playbook -i hosts kafka_cluster.yml --tags clean -- Вычищает данные и все файлы кафки и зукипера, после чего нода готова для повторой конфигурации. 

ansible-playbook -i hosts kafka_cluster.yml --tags reconfigure -- Не трогает данные и бинарники, но перегенерирует конфиги и скрипты с учетом изменений в плейбуке, после чего рестартит сервисы.

ansible-playbook -i hosts kafka_cluster.yml --tags restart -- Просто рестарт кафки на всех нодах.

Прокси можно указать прямо при запуске, не изменяя конфигов:

ansible-playbook -i hosts kafka_cluster.yml --extra-vars '{"proxy_env": {"http_proxy": "http://192.168.122.1:8888", "https_proxy": "http://192.168.122.1:8888"}}'

Для запуска без прокси: 

ansible-playbook -i hosts  kafka_cluster.yml --extra-vars '{"proxy_env": ""}'


Структура папки с ролями:

В каталоге с плейбуком есть папка Roles, где хранятся данные о ролях, разложеные по подпапкам (в нашем случае epel, basic_centos, и kafka_node_centos). Рассмотрим структуру роли на примере kafka_node_centos:

tasks -- Непосредственно задания, запускается main.yml, из него могут вызываться другие файлы с заданиями.

vars -- Файлы переменных, указанные здесь значения имеют один из самых высоких приоритетов, если переменная задана несколькими способами. К примеру значение, заданное в файле инвентаризации будет переопределино. В нашем случае не используется.

defaults -- Тоже файлы переменных, но имеет наинизший приоритет, при необходимости любую переменную можно переопределить любым способом. У нас тут лежат переменные, общие для всех нод.

handlers -- Обработчики, т.е. задачи которые могут выполнятся при успешном завершении какой-либо задачи. В нашем случае не используется.

files -- Папка для файлов, которые передаются на хосты в неизменном виде. Тут лежат дистрибутивы kafka, zookeeper, jmx-explorer и конфиг к нему для кафки.

templates -- Папка для шаблонов конфигурационных файлов, могут содежать переменные и логику. Тут лежат шаблоны для конфигов kafka и zookeeper, юнит-файлов к ним для systemd и скриптов для работы с kafka.

meta -- Зависимости этой роли, от других ролей.

